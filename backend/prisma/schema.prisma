generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ROLES
enum Role {
  ADMIN
  SECRETARY
  TEACHER
  STUDENT
  PARENT
}

// USUARIO (Central de Acceso)
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      Role
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones (Solo una estará llena según el rol)
  staffId   Int?     @unique
  staff     Staff?   @relation(fields: [staffId], references: [id])
  
  studentId Int?     @unique
  student   Student? @relation(fields: [studentId], references: [id])
  
  parentId  Int?     @unique
  parent    Parent?  @relation(fields: [parentId], references: [id])
}

// PERSONAL (Admin, Secretaria, Docentes)
model Staff {
  id        Int      @id @default(autoincrement())
  names     String
  lastName  String
  dni       String   @unique
  phone     String?
  email     String?
  address   String?
  
  user      User?
  
  // Docentes
  groups    Group[]  // Grupos a cargo (Many-to-Many implicit)
}

// EL PADRE DE FAMILIA
model Parent {
  id        Int       @id @default(autoincrement())
  names     String
  lastName  String
  dni       String    @unique
  phone     String
  email     String?
  
  user      User?
  students  Student[]
}

// EL ALUMNO
model Student {
  id        Int      @id @default(autoincrement())
  names     String
  lastName  String
  dni       String   @unique
  birthDate DateTime?
  phone     String?
  address   String?
  
  parentId  Int?
  parent    Parent?  @relation(fields: [parentId], references: [id])
  
  user      User?
  
  enrollments Enrollment[]
  payments    Payment[]
}

// GESTIÓN ACADÉMICA
model Group {
  id          Int      @id @default(autoincrement())
  name        String   // Ej: "Matemáticas A 2024"
  
  teachers    Staff[]  // Relación Muchos a Muchos con Docentes
  
  enrollments Enrollment[]
  resources   Resource[]
}

model Enrollment {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id])
  groupId   Int
  group     Group    @relation(fields: [groupId], references: [id])
  
  paymentPlanId Int?
  paymentPlan   PaymentPlan? @relation(fields: [paymentPlanId], references: [id])

  enrolledAt DateTime @default(now())
  status    String   @default("ACTIVE") // ACTIVE, COMPLETED, DROPPED, PENDING
}

// GESTIÓN DE PAGOS Y PLANES
model PaymentPlan {
  id           Int      @id @default(autoincrement())
  name         String   // Ej: "Mensualidad", "Trimestral", "Pago Único Curso"
  cost         Decimal  @db.Decimal(10, 2)
  frequency    String   // 'MONTHLY', 'QUARTERLY', 'ONE_TIME'
  installments Int      // Cantidad de cuotas (ej: 1, 3, 6)
  
  enrollments  Enrollment[]
}

model Payment {
  id            Int      @id @default(autoincrement())
  studentId     Int
  student       Student  @relation(fields: [studentId], references: [id])
  amount        Decimal  @db.Decimal(10, 2)
  paidAt        DateTime @default(now())
  
  concept       String   // Ej: "Matrícula 2024", "Pensión Marzo"
  method        String   // Ej: "EFECTIVO", "YAPE", "TRANSFERENCIA"
  operationCode String?  // Para validar transferencias
  
  createdAt     DateTime @default(now())
}

// RECURSOS
model Resource {
  id          Int      @id @default(autoincrement())
  name        String
  url         String
  type        String   // PDF, VIDEO, LINK
  groupId     Int
  group       Group    @relation(fields: [groupId], references: [id])
  createdAt   DateTime @default(now())
}
